from __future__ import annotations

from concurrent.futures import ThreadPoolExecutor

from socket import (
    socket,
    AF_INET,
    SOCK_STREAM
)

from time import sleep

from Tohka.lib.constants import CNC_LOGIN_PROMPTS #type: ignore
from Tohka.lib.colors    import Colors            #type: ignore
from Tohka.lib.ui        import TOHKA             #type: ignore



class NetScan:
    def __init__(self: NetScan, addr: str) -> None:
        self.addr: str = addr
        self.cnc_port: None | str = None
        self.prange: list[int] = [
            number for number in range(10000) if number not in 
            (21, 22, 23, 25, 53, 69, 80, 443, 3074, 3306, 5060, 9307)
        ]
        self.fire()
    

    def fire(self: NetScan) -> None:
        """Start all threads"""
        with ThreadPoolExecutor(max_workers=800) as executor:
            tuple(executor.submit(self.execution) for _ in range(800))


    def execution(self: NetScan) -> None:
        """Cycle threading system"""
        # NOTE: CNC port found (Kills all threads) or port range empty
        while self.prange and not self.cnc_port:

            for port in self.prange:

                if port in self.prange:
                    try:
                        self.prange.remove(port)
                    except:
                        continue

                self.__connect(port)
    

    def __connect(self: NetScan, port: int) -> None:
        """Attempt to connect to the port

        Args:
            port(int): Port to connect to.
        
        Returns:
            None
        """
        with socket(AF_INET, SOCK_STREAM) as sock:
            sock.settimeout(5.0)
            try:
                sock.connect((self.addr, port))
            except:
                return
            
            # NOTE: Some servers dont give a response
            # NOTE: if we dont send one first ¯\_(ツ)_/¯
            sock.send('\r\n'.encode('ascii'))
            sleep(1)
            resp = sock.recv(40960).decode('utf-8',"ignore").lower()

        # NOTE: CNC port found?
        if tuple(prompt for prompt in CNC_LOGIN_PROMPTS if prompt in resp):
            self.cnc_port = port
            return



class TohkaModule:

    def main(params: str) -> None:
        """Find the CNC port of

        Args:
            params(str): Target IP address
        
        Returns:
            None
        """
        print(f'\n{Colors.YELLOW}• {Colors.WHITE}Attempting to find the CNC port...\n')
        handler: NetScan = NetScan(params)    
        handler.fire()
        
        if handler.cnc_port:
            print(f'{Colors.LIME}• {TOHKA} {Colors.WHITE}found the CNC port {Colors.PURPLE}{handler.cnc_port}{Colors.WHITE}.\n')
            return
        print(f'{Colors.RED}• {TOHKA} {Colors.WHITE}failed to find the CNC port{Colors.WHITE}.\n')
